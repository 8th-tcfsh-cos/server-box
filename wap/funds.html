<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" /> -->

    <link rel='stylesheet prefetch' href='https://fonts.googleapis.com/icon?family=Material+Icons'>
    <link rel='stylesheet prefetch' href='https://fonts.googleapis.com/css?family=Roboto'>
<link rel='stylesheet prefetch' href="https://fonts.googleapis.com/css?family=Share+Tech">
    <!-- <link rel="stylesheet" href="/files/fonts.css"/> -->


    <!-- Bootstrap CSS -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->

    <title>表單</title>

    <link rel="shortcut icon" type="image/png" href="/favicon.png"/>
    <meta name="theme-color" content="#AB47BC">

    <link rel="stylesheet" href="/files/material.teal-blue.min.css"/>
    <link rel="stylesheet" href="/files/material-components-web.min.css"/>
    <!-- <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.teal-blue.min.css"/> -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"/> -->


    <link rel="stylesheet" href="/files/bootstrap.css" media="screen">
    <link rel="stylesheet" href="/files/custom.min.css">
    <link rel="stylesheet" href="/files/style.css?v=1.6">
    <link rel="stylesheet" href="./wap.css?v=1.6">
    <!-- <link rel="stylesheet" href="https://bootswatch.com/4/darkly/bootstrap.min.css"> -->

    <!-- Nice fonts -->
    
    
    
</head>

<body id="body">
    <div id="top-bar"></div>

    <div id="drawer"></div>

    <div id="main-content" class="page-content">

        <div class="section-header clearfix" id="title">
            <div class="row">
                <div class="col-lg-12">
                    <div class="page-header">
                        經費申請表
                    </div>
                </div>
            </div>
        </div>

        <br>

        <div id="status">
        </div>

        <!-- for debugging purposes -->
        <!-- <button class="mat-button mdc-button--raised mdc-button" onClick="showOverlay()">Open</button> -->

        <div id="tmp-success" style="display: none;">
            <div id="submitted" class="alert alert-dismissible alert-primary">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                已成功提交您的申請書。
            </div>
        </div>

        <div id="tmp-error" style="display: none;">
            <div id="n-submitted" class="alert alert-dismissible alert-danger">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                無法提交表單，伺服器傳回以下錯誤：
                <br>
                <div id="error-log">
                    <!-- for error log -->
                </div>
            </div>
        </div>

        <form id="funds-form" action="process-funds.php" method="post" enctype="multipart/form-data">
            <br>
            <p>
                如果你有成發相關的任何東西需要經費，你可以填這份表單向 0822 的總務組申請。<strong>注意：總務組不一定會給你錢。</strong>
            </p>
            <p>
                <i>「當我身上缺錢的時候，總務組不知從哪裡弄來鉅款，偷偷接濟我。」</i>
            </p>
            <div class="form-group" style="margin-bottom: 6.4px;">
                <div class="mdc-text-field mdc-text-field--outlined" id="yourname-container" style="width: 100%">
                    <input name="name" id="yourname" class="mdc-text-field__input" style="width: 100%" autocomplete="off" required="true" onInput="onTextChange(this)">
                    <label for="yourname" class="mdc-floating-label">你的名字</label>
                    <!-- <i class="material-icons mdc-text-field-icon mdc-text-field__icon" tabindex="0" role="button" onClick="document.getElementById('yourname').value='';">delete</i> -->
                    <div class="mdc-notched-outline">
                        <svg>
                            <path class="mdc-notched-outline__path"/>
                        </svg>
                    </div>
                    <div class="mdc-notched-outline__idle"></div>
                </div>
                <div class="mdc-text-field mdc-text-field--outlined" id="money-container" style="width: 100%">
                    <!-- <input name="name" id="yourname" class="mdc-text-field__input" style="width: 100%" autocomplete="off" required="true" onInput="onTextChange(this)"/> -->
                    <input name="amount" id="money" class="mdc-text-field__input" autocomplete="off" required="true"  style="width: 100%" onInput="onTextChange(this)"/>
                    <label for="yourname" class="mdc-floating-label">申請金額 (新台幣)</label>
                    <!-- <i class="material-icons mdc-text-field-icon mdc-text-field__icon" tabindex="0" role="button" onClick="document.getElementById('yourname').value='';">delete</i> -->
                    <div class="mdc-notched-outline">
                        <svg>
                            <path class="mdc-notched-outline__path"/>
                        </svg>
                    </div>
                    <div class="mdc-notched-outline__idle"></div>
                </div>
            </div>
            <div class="form-group">
                <div class="mdc-text-field text-field mdc-text-field--fullwidth mdc-text-field--textarea mdc-text-field--upgraded" id="yoursub-container">
                    <textarea name="submission" id="yoursub" class="mdc-text-field__input" required onInput="onTextChange(this)"></textarea>
                    <label class="mdc-floating-label" for="yoursub">申請項目 / 緣由</label>
                    <!-- <i class="material-icons mdc-text-field__icon" data-mdc-tooltip="你的投稿內容" role="img" tabindex="0">info</i> -->
                </div>
            </div>
            <div class="form-group recaptcha-container">

                <div class="g-recaptcha" data-theme="dark" data-size="normal" data-sitekey="6LeAqGkUAAAAAD81DFKbkAC-bgP1MYS5Tq3HQS9n">
                </div>
            </div>
            <div class="form-group">
                <button id="submit-button" type="button" class="mat-button mdc-button mdc-button--raised purple-button" onClick="validate()">送出</button>
                <!-- &nbsp; -->
                <button id="reset-button" type="button" class="mat-button mdc-button mdc-button--raised gray-button" onClick="resetForm()">清除</button>
            </div>
        </form>

        <footer id="footer">
        <!-- will be loaded using javascript -->
    </footer>

    </div>

    <aside id="confirm-submission-dialog" class="mdc-dialog">
        <div class="mdc-dialog__surface">
            <header class="mdc-dialog__header">
                <h2 id="confirm-submission-dialog-label" class="mdc-dialog__header__title">
                    確認上傳
                </h2>
            </header>
            <section id="confirm-submission-dialog-description" class="mdc-dialog__body">
                確定要提交這些內容?
            </section>
            <footer class="mdc-dialog__footer">
                <button type="button" class="mat-button mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept" onclick="$('#funds-form').submit()">確定</button>
                <button type="button" class="mat-button mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel">取消</button>
            </footer>
        </div>
        <div class="mdc-dialog__backdrop"></div>
    </aside>

    <aside id="form-incomplete-dialog" class="mdc-dialog">
        <div class="mdc-dialog__surface">
            <header class="mdc-dialog__header">
                <h2 id="form-incomplete-dialog-label" class="mdc-dialog__header__title">
                    表單未完成
                </h2>
            </header>
            <section id="form-incomplete-dialog-description" class="mdc-dialog__body">
                請確認你有正確的填完此表單。
            </section>
            <footer class="mdc-dialog__footer">
                <button type="button" class="mat-button mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept">確定</button>
            </footer>
        </div>
        <div class="mdc-dialog__backdrop"></div>
    </aside>

    <aside id="not-robot-dialog" class="mdc-dialog">
        <div class="mdc-dialog__surface">
            <header class="mdc-dialog__header">
                <h2 id="not-robot-dialog-label" class="mdc-dialog__header__title">
                    你484機器人?
                </h2>
            </header>
            <section id="not-robot-dialog-description" class="mdc-dialog__body">
                就算是也請按「我不是機器人」。
            </section>
            <footer class="mdc-dialog__footer">
                <button type="button" class="mat-button mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--accept">4</button>
                <button type="button" class="mat-button mdc-button mdc-dialog__footer__button mdc-dialog__footer__button--cancel">84</button>
            </footer>
        </div>
        <div class="mdc-dialog__backdrop"></div>
    </aside>

    <div id="sending-overlay" class="overlay" style="height: 0%; width: 100%;">
        <!-- <a href="javascript:void(0)" class="overlay-closebtn" onclick="closePost(0)">&times;</a> -->
        <div class="overlay-content">
            <p>
                資料傳送中
            </p>
            <!-- progress bar -->
            <div id="sending-bar">

            </div>
            <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate">
                <div class="mdc-linear-progress__buffering-dots"></div>
                <div class="mdc-linear-progress__buffer"></div>
                <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                </div>
                <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="/files/jquery.min.js"></script>
    <script type="text/javascript" src="/files/jquery.form.min.js"></script>
    <script type="text/javascript" src="/files/build.js?v=1.6"></script>

    <script type="text/javascript" src="/files/popper.min.js"></script>
    <script type="text/javascript" src="/files/bootstrap.min.js"></script>


    <!-- <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script> -->
    <script defer src="/files/material-components-web.min.js"></script>
    <!-- <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script> -->
    <!-- <script defer src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script> -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> -->

    <!-- recaptcha API -->
    <script src='https://www.google.com/recaptcha/api.js?hl=zh-TW'></script>

    <script>
        function showOverlay() {
            // show 'sending form' overlay
            st = document.getElementById("sending-overlay").style;
            st.height = "100%";

            // const bar = $('.mdc-linear-progress')[0];
            //
            // // const MDCLinearProgress = new mdc.linearProgress.MDCLinearProgress;
            // // const MDCLinearProgressFoundation = new mdc.linearProgress.MDCLinearProgressFoundation;
            //
            // const progress = new mdc.linearProgress.MDCLinearProgress(bar);
            //
            // // progressFoundation.setDeterminate(false);
            // progress.progress = 1;

            // $('#sending-bar')[0].innerHTML = $('#loading-bar')[0].innerHTML;
        }

        /* Close when someone clicks inside the overlay */
        function closeOverlay() {
            st = document.getElementById("sending-overlay").style;
            st.height = "0%";
        }

        // preventing enter key from submitting the form
        $(document).on("keypress", ":input:not(textarea)", function(event) {
            return event.keyCode != 13;
        });

        function isGoodMoney(n){
            if(isNaN(n)) return false;
            if(+n <= 10 || +n > 1000000) return false;
            if(+n != Math.floor(n)) return false;
            return true;
        }

        function onTextChange(e) {
            var a = new mdc.textField.MDCTextField(document.querySelector('#' + e.id + '-container'));
            if(e.value.trim() == "") {
                a.valid = false;
            } else {
                if(e.id == "yoursub") {
                    a.valid = e.value.length >= 20;
                } else if(e.id == "money") {
                    a.valid = isGoodMoney(e.value);
                } else {
                    a.valid = true;
                }
            }
        }

        function resetForm(){
            // reset text fields and their styles
            document.getElementById('yourname').value = "";
            var name = new mdc.textField.MDCTextField(document.querySelector('#yourname-container'));
            name.valid = true;
            document.getElementById('money').value = "";
            var money = new mdc.textField.MDCTextField(document.querySelector('#money-container'));
            money.valid = true;
            document.getElementById('yoursub').value = "";
            var sub = new mdc.textField.MDCTextField(document.querySelector('#yoursub-container'));
            sub.valid = true;

            // reset captcha
            grecaptcha.reset();
        }

        function submitForm() {
            // clear all fields
            resetForm();
            // scroll to top
            $("html, body").animate({ scrollTop: 0 }, "fast");
        }

        // client-side validation for the form
        function validate(){
            var valid = true;
            var yourname = document.getElementById('yourname').value;
            var money = document.getElementById('money').value;
            var yoursub = document.getElementById('yoursub').value;
            if(yourname.trim() == "") valid = false;
            if(!isGoodMoney(money)) valid = false;
            if(yoursub.trim().length < 20) valid = false;
            if(!valid) {
                // show invalid dialog
                var incomplete_dialog = new mdc.dialog.MDCDialog(document.querySelector('#form-incomplete-dialog'));
                incomplete_dialog.show();
            } else {
                // client side check for captcha
                if(grecaptcha.getResponse() == '') {
                    var captcha_dialog = new mdc.dialog.MDCDialog(document.querySelector('#not-robot-dialog'));
                    captcha_dialog.show();
                } else {
                    var confirm_dialog = new mdc.dialog.MDCDialog(document.querySelector('#confirm-submission-dialog'));
                    confirm_dialog.show();
                }
            }
        }

        $(function() {
            // bind form and provide a simple callback function
            // $('#funds-form').ajaxForm(submitForm);
            //

        });

        $("#funds-form").submit(function(event) {

            /* stop form from submitting normally */
            event.preventDefault();

            // show sending overlay
            showOverlay();

            /* get some values from elements on the page: */
            var $form = $(this);
            // term = $form.find('input[name="name"]').val(),
            // url = $form.attr('action');

            var sent = false;
            var timeout = false;

            setTimeout(function(){
                // if server didn't respond in 10 secs
                if(!sent){
                    submitForm();
                    closeOverlay();
                    document.getElementById('error-log').innerHTML = "Network timeout";
                    document.getElementById('status').innerHTML = document.getElementById('tmp-error').innerHTML;
                    timeout = true;
                }
            }, 10000);

            /* Send the data using post */
            var posting = $.post("process-funds.php", $form.serialize());

            /* Put the results in a div */
            posting.done(function(data) {
                sent = true
                if(timeout) return;
                // $("#result").empty().append(data);
                submitForm();
                closeOverlay();
                if(data == '0'){
                    // show success nofification
                    document.getElementById('status').innerHTML = document.getElementById('tmp-success').innerHTML;
                } else {
                    // print error log
                    var errmsg = "";
                    switch(data) {
                        case "1":
                        errmsg = "500 Internal Server Error. This is probably a server-side bug, please try again or contact the developer.";
                        break;
                        case "2":
                        errmsg = "Invalid input.";
                        break;
                        case "3":
                        errmsg = "Captcha not verified.";
                        break;
                        default:
                        errmsg = "Unknown Error. This is definitely a bug, please try again or contact the developer.";
                    }
                    document.getElementById('error-log').innerHTML = errmsg;
                    // show error nofification
                    document.getElementById('status').innerHTML = document.getElementById('tmp-error').innerHTML;
                }
            });
        });

    </script>

</body>
</html>
